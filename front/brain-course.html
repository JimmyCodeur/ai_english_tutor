<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Course</title>
    <link rel="stylesheet" href="../static/assets/css/style.css">
    <link rel="stylesheet" href="../static/assets/css/uikit.css">
    <link rel="stylesheet" href="../static/assets/css/icons.css">
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css">
    <link href="../static/assets/images/favicon.png" rel="icon" type="image/png">
</head>



<body class="flex flex-col min-h-screen bg-gray-100">
    <div id="wrapper" class="is-verticle">
        <!-- Barre de navigation -->
        <header uk-sticky> 
            <div class="header_inner">
                <div class="left-side">
                    <div id="logo" class="logo-container">
                        <a href="home.html">
                            <img src="../static/assets/images/logo.png" class="logo-image" alt="">
                            <img src="../static/assets/images/logo-light.png" class="logo_inverse" alt="">
                            <img src="../static/assets/images/logo-mobile.png" class="logo_mobile" alt="">
                        </a>
                    </div>
                    <div class="triger" uk-toggle="target: #wrapper ; cls: is-active"> 
                    </div>
                </div>
                <div class="right-side">                        
                    <div> 
                        <a href="" class="flex items-center space-x-2">
                            <img src="../static/assets/images/avatars/placeholder.png" class="header_widgets_avatar mr-3" alt=""> 
                        </a>
                        <div uk-drop="mode: click;offset:5" class="header_dropdown profile_dropdown">
                            <ul>   
                                <li>
                                    <a href="" class="user">
                                        <div class="user_avatar">
                                            <img src="../static/assets/images/avatars/avatar-2.jpg" alt="">
                                        </div>
                                        <div class="user_name">
                                            <div id="profile-name" class="info-name"></div>
                                            <span id="profile-email" class="info-email"></span>
                                        </div>
                                    </a>
                                </li>
                                <li> 
                                    <a href="users-profile.html">
                                        <ion-icon name="person-circle-outline" class="is-icon"></ion-icon>
                                         Mon Compte 
                                    </a>
                                </li>
                                <li> 
                                    <a href="users-profile.html">
                                        <ion-icon name="folder-outline" class="is-icon"></ion-icon>
                                         Historique 
                                    </a>
                                </li>
                                <li>
                                    <a href="profile-setting.html">
                                        <ion-icon name="settings-outline" class="is-icon"></ion-icon>
                                        Configuration  
                                    </a>
                                </li>
                                <li> 
                                    <hr>
                                </li>
                                <li> 
                                    <a href="#" id="logout-link" onclick="logout()">
                                        <ion-icon name="log-out-outline" class="is-icon"></ion-icon>
                                        Se d√©connecter 
                                    </a>
                                </li>
                            </ul>
                        </div> 
                    </div>
                </div>
            </div>
        </header>

        <!-- Section avec l'image agrandie de l'avatar -->
        <main class="flex-1 flex flex-col items-center justify-center">

            <div class="w-full flex justify-center my-8">
                <img id="avatarGif" src="../static/assets/images/ai/brain.png" class="w-64 h-64 rounded-full" alt="Avatar de l'IA">              

            </div>
        </main>

        <!-- Chat Section -->
        <section class="chat-container w-full max-w-4xl bg-white rounded-lg p-6 mx-auto my-8 shadow-lg">
            <!-- Barre de titre -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="lg:text-2xl text-lg font-bold">Chat</h1>
                <div id="loadingIndicator" class="loading-indicator hidden mt-4 flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A8.001 8.001 0 0112 4.472v3.498L6.295 17.29a7.962 7.962 0 01-.294-1.999zM20 12c0-4.418-3.582-8-8-8v3.472a7.98 7.98 0 013.75 1.069l4.192-4.192A7.963 7.963 0 0120 12zm-6 5.291V16.5l4.185-4.185a8.045 8.045 0 01-2.369-1.935l-3.5 3.5zm-4.185-9.78L7.5 7.5l4.185-4.185v3.472A7.98 7.98 0 018.815 7.51z"></path>
                    </svg>
                    <span class="text-yellow-500">En cours</span>
                </div>          
            </div>
        
            <!-- Chat Box -->
            <div id="chatBox" class="chat-box h-80 overflow-y-auto mb-4 p-4 bg-gray-100 rounded-lg border border-gray-300">
                <!-- <audio id="generatedAudio" controls></audio> -->

            </div>    
        
            <!-- Suggestions Box -->
            <div id="suggestionsBox" class="mb-4"></div>

            <!-- <svg class="h-8 w-8 text-pink-500"  width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">  <path stroke="none" d="M0 0h24v24H0z"/>  <path d="M5 7h7m-2 -2v2a5 8 0 0 1 -5 8m1 -4a7 4 0 0 0 6.7 4" />  <path d="M11 19l4 -9l4 9m-.9 -2h-6.2" /></svg> -->

        
            <!-- Champ de texte pour parler -->
            <!-- <textarea id="userInputField" class="user-input w-full p-1 border border-gray-300 rounded-lg mb-2 h-8 text-xs" rows="2" placeholder="Entrez votre message..."></textarea> -->

        
            <!-- Boutons d'action -->
            <div class="action-buttons flex justify-between">
                <button id="toggleRecording" class="btn-microphone bg-green-500 text-white py-2 px-4 rounded-lg mr-2 flex items-center" onclick="toggleRecording()">
                    <svg class="h-6 w-6 text-white mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z"/>  
                        <rect x="9" y="2" width="6" height="11" rx="3" />  
                        <path d="M5 10a7 7 0 0 0 14 0" />  
                        <line x1="8" y1="21" x2="16" y2="21" />  
                        <line x1="12" y1="17" x2="12" y2="21" />
                    </svg>
                    Parler
                </button>
                <button id="toggleTextArea" class="bg-blue-500 text-white py-2 px-4 rounded-lg flex items-center" onclick="toggleTextArea()">
                    <svg class="h-6 w-6 text-white mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                    </svg>
                    Clavier
                </button>
            </div>
            <textarea id="userInputField" class="user-input w-full p-2 border border-gray-300 rounded-lg mb-2 hidden" rows="2" placeholder="Entrez votre message..."></textarea>
            <button id="sendTextMessage" class="bg-yellow-500 text-white py-2 px-4 rounded-lg hidden" onclick="sendTextMessage()">Envoyer</button>
            <!-- Indicateur de chargement -->
        </section>
        
    </div>
</body>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="../static/assets/js/uikit.js"></script>
    <script src="../static/assets/js/tippy.all.min.js"></script>
    <script src="../static/assets/js/simplebar.js"></script>
    <script src="../static/assets/js/custom.js"></script>
    <script src="../static/assets/js/bootstrap-select.min.js"></script>
    <script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>

    <script>
        let recorder;
        let audioChunks = [];
        let recording = false;
        let initialChatStarted = false;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const choice = urlParams.get('choice');
            await startChat(choice);
        });

        async function startChat(choice) {
            updateButtonState('processing');
            try {
                const response = await fetch('/chat_repeat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ choice: choice })
                });
                const data = await response.json();
                displayMessage(data.generated_response, 'bot', data.audio_base64);

                const audioBase64 = data.audio_base64;
                const audioElement = document.getElementById('generatedAudio');
                if (audioElement) {
                    audioElement.src = "data:audio/wav;base64," + audioBase64;
                    audioElement.style.display = "none";
                    audioElement.style.display = "block";
                    audioElement.className = 'audio-player hidden-audio';

                    // Lecture automatique d√®s que la source est d√©finie
                    audioElement.play().then(() => {
                        // Actions suppl√©mentaires lors de la lecture
                        document.getElementById('avatarGif').src = "../static/assets/images/ai/brain.gif";
                    }).catch((error) => {
                        console.error('Error playing audio:', error);
                    });

                } else {
                    console.error('Element with ID "generatedAudio" not found.');
                }

                document.getElementById('loadingIndicator').classList.add('hidden');
            } catch (err) {
                console.error('Error starting chat: ', err);
            } finally {
                updateButtonState('start');
            }
        }


        async function toggleRecording() {
            if (!recording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    const audioTracks = stream.getAudioTracks();
                    if (audioTracks.length === 0 || !audioTracks[0].enabled) {
                        throw new Error("Microphone is muted or inactive.");
                    }
                    recorder = new MediaRecorder(stream);
                    recorder.ondataavailable = e => audioChunks.push(e.data);
                    recorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks);
                        const formData = new FormData();
                        formData.append('audio_file', audioBlob, 'recorded_audio.wav');
                        const urlParams = new URLSearchParams(window.location.search);
                        const choice = urlParams.get('choice');
                        formData.append('choice', choice);
                        updateButtonState('processing');
                        try {
                            const response = await fetch('/chat_repeat', {
                                method: 'POST',
                                body: formData
                            });
                            const data = await response.json();
                            console.log(data);

                            if (data.error === "unknown_language") {
                                displayMessage("üòµ‚Äçüí´ Il semble que ta prononciation n'est pas bonne, ou tu parles en fran√ßais, recommencez.", 'bot', null, true);
                            } else {
                                if (data.user_input) {
                                    displayMessage(data.user_input, 'user');
                                }

                                if (data.generated_response) {
                                    displayMessage(data.generated_response, 'bot', data.audio_base64);
                                }

                                if (data.suggestions) {
                                    appendSuggestions(data.suggestions);
                                }
                            }

                        } catch (err) {
                            console.error('Error sending audio data to server: ', err);
                            displayErrorMessage("Erreur lors de l'enregistrement, recommencez.");
                        } finally {
                            audioChunks = [];
                            recording = false;
                            updateButtonState('start');
                        }
                    };
                    recorder.start();
                    recording = true;
                    updateButtonState('stop');
                } catch (err) {
                    if (err.name === 'DOMException' && err.message.includes('Requested device not found')) {
                        console.error('Error starting recording: ', err);
                        displayErrorMessage("Microphone non trouv√©. Veuillez v√©rifier que votre microphone est connect√© et fonctionne correctement.");
                    } else {
                        console.error('Error starting recording: ', err);
                        displayErrorMessage("üéôÔ∏è Erreur lors du d√©marrage de l'enregistrement : Microphone inactif ou muet.");
                    }
                }
            } else {
                recorder.stop();
            }
        }

        function appendSuggestions(suggestions) {
            const chatBox = document.getElementById('chatBox');
            const suggestionsTitle = document.createElement('div');
            suggestionsTitle.className = 'suggestions-title text-gray-500 font-bold mb-2';
            suggestionsTitle.textContent = 'Suggestion : ‚¨áÔ∏è';

            chatBox.appendChild(suggestionsTitle);

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach((suggestion, index) => {
                    if (suggestion.trim() !== "") {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.className = 'div bg-yellow-200 text-blue-800 p-2 rounded mb-2';
                        suggestionDiv.textContent = suggestion;
                        suggestionDiv.setAttribute('data-index', index);
                        suggestionDiv.addEventListener('click', () => {
                            const userInputField = document.getElementById('userInputField');
                            userInputField.value = suggestion;
                        });
                        chatBox.appendChild(suggestionDiv);
                    }
                });
            } else {
                const noSuggestionsDiv = document.createElement('div');
                noSuggestionsDiv.className = 'no-suggestions text-red-500';
                noSuggestionsDiv.textContent = "Aucune suggestion disponible.";
                chatBox.appendChild(noSuggestionsDiv);
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function displayMessage(message, sender, audioBase64, isError = false) {
            const chatBox = document.getElementById('chatBox');

            if (["Thank you.", "Obrigado.", "Tchau.", "E a",".","Bye."].includes(message.trim())) {
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'message bg-orange-100 text-black-500 rounded-lg p-2 max-w-xs';
                errorMessageDiv.textContent = "üó£Ô∏è Aucun audio d√©tect√©, recommencez.";
                chatBox.appendChild(errorMessageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                return;
            }
            if (!message) return; 

            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container mb-2';

            const messageDiv = document.createElement('div');
            if (isError) {
                messageDiv.className = 'message bg-red-500 text-white rounded-lg p-2 max-w-xs';
            } else if (message.startsWith('Traduction :')) {
                // Pour le message traduit, changer la couleur de fond en orange
                messageDiv.className = 'message bg-green-200 text-black rounded-lg p-2 max-w-xs';
            } else {
            if (sender === 'bot') {
                messageDiv.className = 'message bg-gray-200 rounded-lg text-black';
            } else {
                messageDiv.className = 'message self bg-blue-500 text-white rounded-lg';
            }
        }
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);
            
            // Add translate icon only if message does not start with 'translated_message'
            if (!message.startsWith('Traduction :') && sender === 'bot') {
                const iconSVG = `
                    <svg class="h-6 w-6 text-pink-500 inline-block ml-2 cursor-pointer translate-icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-message="${message}">
                        <path stroke="none" d="M0 0h24v24H0z"/>
                        <path d="M5 7h7m-2 -2v2a5 8 0 0 1 -5 8m1 -4a7 4 0 0 0 6.7 4"/>
                        <path d="M11 19l4 -9l4 9m-.9 -2h-6.2"/>
                    </svg>
                `;
                messageContainer.insertAdjacentHTML('beforeend', iconSVG);
            }

            if (audioBase64) {
                const audioElement = document.createElement('audio');
                audioElement.controls = true;
                audioElement.src = "data:audio/wav;base64," + audioBase64;
                audioElement.className = 'audio-player hidden-audio';
                audioElement.addEventListener('loadeddata', () => {
                    audioElement.play();
                });

                // Add event listeners to change avatar
                audioElement.onplay = () => {
                    changeAvatarToGif(); // Change avatar to GIF when audio starts
                };
                audioElement.onpause = () => {
                    changeAvatarToPng(); // Change avatar to PNG when audio pauses
                };
                audioElement.onended = () => {
                    changeAvatarToPng(); // Change avatar to PNG when audio ends
                };

                messageContainer.appendChild(audioElement);
                const replayIconSVG = `
                    <svg class="h-6 w-6 text-zinc-500 cursor-pointer replay-icon"  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                    </svg>
                `;
                messageContainer.insertAdjacentHTML('beforeend', replayIconSVG);
            } 
            
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            const translateIcon = messageContainer.querySelector('.translate-icon');
            if (translateIcon) {
                translateIcon.addEventListener('click', () => {
                    const message = translateIcon.getAttribute('data-message');
                    translateMessage(message);
                    messageContainer.style.color = 'black'; // Change text color on translate click
                    translateIcon.remove();
                });
            }
            const replayIcon = messageContainer.querySelector('.replay-icon');
            if (replayIcon) {
                replayIcon.addEventListener('click', () => {
                    const audioPlayer = messageContainer.querySelector('.audio-player');
                    if (audioPlayer) {
                        audioPlayer.play();
                    }
                });
            }    
        }


        function translateMessage(message) {
            const translateUrl = 'http://localhost:8000/translate/';

            // Corps de la requ√™te √† envoyer √† FastAPI
            const requestBody = {
                message: message
            };

            // Options de la requ√™te fetch
            const fetchOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            };

            // Envoyer la requ√™te √† FastAPI pour la traduction
            fetch(translateUrl, fetchOptions)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Erreur lors de la traduction');
                })
                .then(data => {
                    // R√©ussite de la requ√™te, afficher la traduction
                    const translatedMessage = data.translated_message;
                    console.log(`Message traduit: "${translatedMessage}"`);
                    
                    // Trouver le dernier message affich√© dans le chat
                    const messageContainer = document.querySelector('.message-container:last-child');

                    // Mettre √† jour l'interface utilisateur avec le message traduit
                    if (messageContainer) {
                        displayMessage(`Traduction : ${translatedMessage}`, 'bot');
                        
                        const translateIcon = messageContainer.querySelector('.translate-icon');
                        if (translateIcon) {
                            translateIcon.remove();  // Retirer l'ic√¥ne de traduction du message traduit
                        }
                    } else {
                        console.error('Erreur lors de la traduction: Aucun messageContainer trouv√©.');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la traduction:', error);
                    // G√©rer les erreurs ici, par exemple afficher un message d'erreur √† l'utilisateur
                });
        }


        function displayErrorMessage(errorMessage) {
            const chatBox = document.getElementById('chatBox');
            const errorMessageDiv = document.createElement('div');
            errorMessageDiv.className = 'message text-red-500 rounded-lg p-2 max-w-xs';
            errorMessageDiv.textContent = errorMessage;
            chatBox.appendChild(errorMessageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateButtonState(state) {
            const button = document.getElementById('toggleRecording');
            const loadingIndicator = document.getElementById('loadingIndicator');

            switch (state) {
                case 'start':
                    button.textContent = "Parler";
                    button.classList.remove('hidden');
                    button.classList.remove('bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'text-white');
                    button.classList.add('bg-green-500', 'text-white');
                    loadingIndicator.classList.add('hidden');
                    break;
                case 'stop':
                    button.textContent = "Arr√™ter l'enregistrement";
                    button.classList.remove('bg-green-500', 'bg-orange-500', 'bg-yellow-500', 'text-white');
                    button.classList.add('bg-red-500', 'text-white');
                    loadingIndicator.classList.add('hidden');
                    break;
                case 'processing':
                    button.classList.add('hidden');
                    loadingIndicator.classList.remove('hidden');
                    break;
                default:
                    break;
            }
        }

        function monitorAudioVolume(audioElement) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audioElement);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function checkVolume() {
                analyser.getByteFrequencyData(dataArray);
                const volume = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                if (volume < 10) {
                    changeAvatarToPng();
                } else {
                    changeAvatarToGif();
                }
                requestAnimationFrame(checkVolume);
            }

            audioElement.onplay = () => {
                audioContext.resume().then(() => {
                    checkVolume();
                });
            };
        }

       
        function changeAvatarToGif() {
            const avatarImg = document.getElementById('avatarGif');
            avatarImg.src = "../static/assets/images/ai/brain.gif"; // Assurez-vous que ce chemin est correct
        }

        function changeAvatarToPng() {
            const avatarImg = document.getElementById('avatarGif');
            avatarImg.src = "../static/assets/images/ai/brain.png"; // Assurez-vous que ce chemin est correct
        }
        
        function toggleTextArea() {
            const userInputField = document.getElementById('userInputField');
            const sendTextMessageButton = document.getElementById('sendTextMessage');

            if (userInputField.classList.contains('hidden')) {
                userInputField.classList.remove('hidden');
                sendTextMessageButton.classList.remove('hidden');
            } else {
                userInputField.classList.add('hidden');
                sendTextMessageButton.classList.add('hidden');
            }
        }

    async function sendTextMessage() {
        const userInputField = document.getElementById('userInputField');
        const message = userInputField.value.trim();

        if (message) {
            displayMessage(message, 'user');
            userInputField.value = '';
            updateButtonState('processing');
            try {
                const response = await fetch('/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                const data = await response.json();
                if (data.generated_response) {
                    displayMessage(data.generated_response, 'bot', data.audio_base64);
                }
                if (data.suggestions) {
                    appendSuggestions(data.suggestions);
                }
            } catch (err) {
                console.error('Error sending text message: ', err);
                displayErrorMessage("Erreur lors de l'envoi du message texte.");
            } finally {
                updateButtonState('start');
            }
        }
    }
            


    </script>
</body>

</html>
