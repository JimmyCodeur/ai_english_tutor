<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkAI - Analyse & Rapports</title>
    <meta name="description" content="TalkAI - Analyse de vos sessions d'apprentissage">
    <link href="/static/assets/images/favicon.png" rel="icon" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuration Tailwind personnalis√©e -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0eaff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#667eea',
                            600: '#5a67d8',
                            700: '#4c51bf',
                            800: '#434190',
                            900: '#3c366b',
                        },
                        secondary: {
                            500: '#764ba2',
                            600: '#6b46c1',
                            700: '#553c9a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .sidebar-backdrop {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.3);
        }
        .mobile-menu-open {
            transform: translateX(0);
        }
        .mobile-menu-closed {
            transform: translateX(-100%);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateX(4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .session-item {
            transition: all 0.3s ease;
        }
        .session-item:hover {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            transform: translateX(8px);
        }
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring__circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.35s;
        }
        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .character-emma { background: linear-gradient(135deg, #667eea, #764ba2); }
        .character-tom { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .character-lucy { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .character-ben { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .character-alice { background: linear-gradient(135deg, #fa709a, #fee140); }
        .character-mike { background: linear-gradient(135deg, #a8edea, #fed6e3); }
        .character-sarah { background: linear-gradient(135deg, #667eea, #764ba2); }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Mobile Menu Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 z-40 sidebar-backdrop hidden lg:hidden"></div>
    
    <!-- Container principal -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 glass-effect border-b border-gray-200/20 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo et menu mobile -->
                    <div class="flex items-center space-x-4">
                        <!-- Bouton menu mobile -->
                        <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <!-- Logo -->
                        <a href="home.html" class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center shadow-lg">
                                <span class="text-2xl font-bold text-white">T</span>
                            </div>
                            <span class="text-gray-900 font-bold text-xl hidden sm:block">TalkAI</span>
                        </a>
                    </div>
                    
                    <!-- Navigation desktop -->
                    <nav class="hidden lg:flex items-center space-x-8">
                        <a href="home.html" class="text-gray-600 hover:text-primary-600 transition-colors font-medium">
                            Cours
                        </a>
                        <a href="analysis.html" class="text-primary-600 font-semibold border-b-2 border-primary-500 pb-1">
                            Mes Rapports
                        </a>
                    </nav>
                    
                    <!-- Profil utilisateur -->
                    <div class="relative">
                        <button id="profile-btn" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 transition-colors">
                            <img id="profile-avatar" src="/static/assets/images/avatars/placeholder.png"
                                 class="w-8 h-8 rounded-full ring-2 ring-primary-500" alt="Avatar">
                            <div class="hidden sm:block text-left">
                                <div id="profile-name" class="text-sm font-semibold text-gray-900">Chargement...</div>
                                <div id="profile-email" class="text-xs text-gray-500">Chargement...</div>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Menu profil -->
                        <div id="profile-menu" class="hidden absolute right-0 mt-2 w-64 glass-effect rounded-2xl shadow-xl border border-gray-200/20 py-2 z-50">
                            <div class="px-4 py-3 border-b border-gray-200/20">
                                <div class="flex items-center space-x-3">
                                    <img id="profile-avatar-menu" src="/static/assets/images/avatars/placeholder.png"
                                         class="w-12 h-12 rounded-full" alt="Avatar">
                                    <div>
                                        <div id="profile-name-menu" class="font-semibold text-gray-900">Chargement...</div>
                                        <div id="profile-email-menu" class="text-sm text-gray-500">Chargement...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="py-2">
                                <a href="users-profile.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Mon Compte
                                </a>
                                <a href="profile-setting.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                    <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Configuration
                                </a>
                                <hr class="my-2 border-gray-200/20">
                                <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Se d√©connecter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar mobile -->
        <div id="mobile-sidebar" class="fixed inset-y-0 left-0 z-50 w-64 mobile-menu-closed transition-transform duration-300 lg:hidden">
            <div class="h-full glass-effect border-r border-gray-200/20">
                <div class="p-6">
                    <nav class="space-y-3">
                        <a href="home.html" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:text-primary-600 hover:bg-gray-50 rounded-xl transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            Cours
                        </a>
                        <a href="analysis.html" class="flex items-center space-x-3 px-4 py-3 text-primary-600 bg-primary-50 rounded-xl font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Mes Rapports
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Contenu principal -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- En-t√™te -->
            <div class="text-center mb-12 animate-fade-in">
                <div class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-full text-sm font-semibold mb-6">
                    üìä Analyse de Performance
                </div>
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    Rapports & Analyses
                </h1>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    Suivez vos progr√®s et analysez vos performances d'apprentissage
                </p>
            </div>

            <!-- Statistiques globales -->
            <div id="globalStatsContainer" class="mb-8 animate-slide-up">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üìà Aper√ßu Global</h2>
                    
                    <!-- Loading de stats globales -->
                    <div id="globalStatsLoading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="loading-skeleton h-24 rounded-xl"></div>
                        <div class="loading-skeleton h-24 rounded-xl"></div>
                        <div class="loading-skeleton h-24 rounded-xl"></div>
                        <div class="loading-skeleton h-24 rounded-xl"></div>
                    </div>
                    
                    <!-- Stats globales -->
                    <div id="globalStats" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Total conversations -->
                            <div class="stat-card border-blue-500 p-6 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div id="totalConversations" class="text-3xl font-bold text-gray-900">0</div>
                                        <div class="text-sm text-gray-600">Conversations totales</div>
                                        <div id="conversationsThisWeek" class="text-xs text-blue-600 mt-1"></div>
                                    </div>
                                    <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total messages -->
                            <div class="stat-card border-green-500 p-6 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div id="totalMessages" class="text-3xl font-bold text-gray-900">0</div>
                                        <div class="text-sm text-gray-600">Messages √©chang√©s</div>
                                        <div id="messagesThisWeek" class="text-xs text-green-600 mt-1"></div>
                                    </div>
                                    <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-1"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Temps total -->
                            <div class="stat-card border-purple-500 p-6 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div id="totalTime" class="text-3xl font-bold text-gray-900">0h</div>
                                        <div class="text-sm text-gray-600">Temps d'apprentissage</div>
                                        <div id="avgSessionTime" class="text-xs text-purple-600 mt-1"></div>
                                    </div>
                                    <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Niveau actuel -->
                            <div class="stat-card border-yellow-500 p-6 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div id="currentLevel" class="text-3xl font-bold text-gray-900">D√©butant</div>
                                        <div class="text-sm text-gray-600">Niveau actuel</div>
                                        <div id="progressPercentage" class="text-xs text-yellow-600 mt-1"></div>
                                    </div>
                                    <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progression par personnage -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">üé≠ Progression par Personnage</h3>
                            <div id="charactersProgress" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                <!-- Les cartes de personnages seront ajout√©es ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphiques et analyses avanc√©es -->
            <div id="chartsContainer" class="mb-8 animate-slide-up">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Graphique d'activit√© -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">üìÖ Activit√© des 7 derniers jours</h3>
                        <div class="relative h-64">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- R√©partition par type d'erreur -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">üéØ Analyse des erreurs</h3>
                        <div class="relative h-64">
                            <canvas id="errorsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container de l'analyse d√©taill√©e -->
            <div id="analysisContainer" class="hidden mb-12 animate-slide-up">
                <!-- Le contenu sera g√©n√©r√© dynamiquement -->
            </div>

            <!-- Section des sessions -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 animate-slide-up">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">üìã Historique des Sessions</h2>
                            <p class="text-gray-600">Historique complet de vos sessions d'apprentissage</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Filtre par personnage -->
                            <select id="characterFilter"
                                    class="bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                    onchange="loadSessionReports()">
                                <option value="">Tous les personnages</option>
                                <option value="emma">üë©‚Äçüè´ Emma</option>
                                <option value="tom">üçï Tom</option>
                                <option value="lucy">üõçÔ∏è Lucy</option>
                                <option value="ben">üó∫Ô∏è Ben</option>
                                <option value="alice">üåü Alice</option>
                                <option value="mike">üöï Mike</option>
                                <option value="sarah">‚úàÔ∏è Sarah</option>
                            </select>
                            <label for="sortOrder" class="text-sm font-medium text-gray-700">Trier par :</label>
                            <select id="sortOrder"
                                    class="bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                    onchange="loadSessionReports()">
                                <option value="desc">Plus r√©cent</option>
                                <option value="asc">Plus ancien</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des sessions -->
                <div class="p-6">
                    <div id="sessionsLoading" class="space-y-4">
                        <!-- Skeleton loading -->
                        <div class="loading-skeleton h-20 rounded-xl"></div>
                        <div class="loading-skeleton h-20 rounded-xl"></div>
                        <div class="loading-skeleton h-20 rounded-xl"></div>
                    </div>
                    
                    <div id="sessionReports" class="space-y-4 hidden">
                        <!-- Les sessions seront ajout√©es ici -->
                    </div>
                    
                    <div id="noSessions" class="hidden text-center py-12">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Aucune session trouv√©e</h3>
                        <p class="text-gray-600 mb-6">Commencez votre premier cours pour voir vos rapports ici</p>
                        <a href="home.html" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-secondary-600 transition-all">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Commencer un cours
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        // ===== FONCTIONS D'AUTHENTIFICATION CORRIG√âES =====
        function getAuthToken() {
            const token = localStorage.getItem('access_token'); // üî• CORRECTION ICI
            console.log('üîë Token r√©cup√©r√©:', token ? 'Pr√©sent' : 'Absent');
            return token;
        }

        async function authenticatedFetch(url, options = {}) {
            const token = getAuthToken();
            
            if (!token) {
                console.error('‚ùå Token d\'acc√®s manquant');
                window.location.href = '/form-login.html';
                return;
            }
            
            const defaultHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            const requestOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };
            
            try {
                console.log('üåê Requ√™te authentifi√©e vers:', url);
                const response = await fetch(url, requestOptions);
                
                if (response.status === 401) {
                    console.error('‚ùå Token expir√© ou invalide');
                    localStorage.clear();
                    window.location.href = '/form-login.html';
                    return;
                }
                
                return response;
            } catch (error) {
                console.error('‚ùå Erreur lors de la requ√™te authentifi√©e:', error);
                throw error;
            }
        }

        // Variables globales
        let globalStats = {};
        let allConversations = [];
        let activityChart = null;
        let errorsChart = null;

        // Mapping des cat√©gories
        const categoryMapping = {
            "conv_greetings_common_conversations": "üëãüèº Conversations g√©n√©rales",
            "conv_taxi_booking": "üöï R√©servation de taxi",
            "conv_airport_ticket": "‚úàÔ∏è R√©servation de vol",
            "conv_beginner_teacher": "üë©‚Äçüè´ Professeure pour d√©butants",
            "conv_simple_restaurant": "üçï Restaurant simple",
            "conv_simple_shopping": "üõçÔ∏è Shopping basique",
            "conv_simple_directions": "üó∫Ô∏è Demander son chemin"
        };

        // Mapping des personnages
        const characterMapping = {
            "conv_greetings_common_conversations": { name: "Alice", emoji: "üåü", class: "character-alice" },
            "conv_taxi_booking": { name: "Mike", emoji: "üöï", class: "character-mike" },
            "conv_airport_ticket": { name: "Sarah", emoji: "‚úàÔ∏è", class: "character-sarah" },
            "conv_beginner_teacher": { name: "Emma", emoji: "üë©‚Äçüè´", class: "character-emma" },
            "conv_simple_restaurant": { name: "Tom", emoji: "üçï", class: "character-tom" },
            "conv_simple_shopping": { name: "Lucy", emoji: "üõçÔ∏è", class: "character-lucy" },
            "conv_simple_directions": { name: "Ben", emoji: "üó∫Ô∏è", class: "character-ben" }
        };

        // ===== GESTION UI =====
        function initializeUI() {
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileSidebar = document.getElementById('mobile-sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');

            function toggleMobileMenu() {
                mobileSidebar.classList.toggle('mobile-menu-open');
                mobileSidebar.classList.toggle('mobile-menu-closed');
                mobileOverlay.classList.toggle('hidden');
            }

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', toggleMobileMenu);
            }

            // Profile menu toggle
            const profileBtn = document.getElementById('profile-btn');
            const profileMenu = document.getElementById('profile-menu');

            if (profileBtn && profileMenu) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileMenu.classList.toggle('hidden');
                });

                document.addEventListener('click', () => {
                    profileMenu.classList.add('hidden');
                });

                profileMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        // ===== CHARGEMENT DES DONN√âES =====
        async function loadGlobalStats() {
            try {
                console.log('üìä Chargement des statistiques globales...');
                
                // Charger les conversations
                const conversationsResponse = await authenticatedFetch('/user/conversations');
                if (!conversationsResponse || !conversationsResponse.ok) {
                    throw new Error(`Erreur HTTP ${conversationsResponse?.status || 'inconnue'}`);
                }
                
                allConversations = await conversationsResponse.json();
                console.log('üìã Conversations charg√©es:', allConversations.length);

                // Charger la progression utilisateur
                let progressData = {};
                try {
                    const progressResponse = await authenticatedFetch('/user/progress');
                    if (progressResponse && progressResponse.ok) {
                        progressData = await progressResponse.json();
                        console.log('üìà Progression charg√©e:', progressData);
                    }
                } catch (progressError) {
                    console.warn('‚ö†Ô∏è Erreur progression (non bloquante):', progressError);
                }

                // Calculer les statistiques
                await calculateAndDisplayStats(allConversations, progressData);
                
            } catch (err) {
                console.error('‚ùå Erreur lors du chargement des stats globales:', err);
                displayStatsError(err.message);
            }
        }

        async function calculateAndDisplayStats(conversations, progressData) {
            try {
                // Statistiques de base
                const totalConversations = conversations.length;
                let totalMessages = 0;
                let totalTimeMinutes = 0;
                const characterStats = {};

                // Analyser chaque conversation
                for (const conv of conversations) {
                    try {
                        // Charger les messages de cette conversation
                        const messagesResponse = await authenticatedFetch(`/user/r_a_m/${conv.id}/messages`);
                        if (messagesResponse && messagesResponse.ok) {
                            const messages = await messagesResponse.json();
                            totalMessages += messages.length;
                        }

                        // Calculer la dur√©e
                        const startTime = new Date(conv.start_time);
                        const endTime = conv.end_time ? new Date(conv.end_time) : new Date();
                        const durationMs = endTime - startTime;
                        const durationMinutes = Math.max(1, Math.floor(durationMs / 60000)); // Min 1 minute
                        totalTimeMinutes += durationMinutes;

                        // Stats par personnage
                        const character = getCharacterFromCategory(conv.category);
                        if (!characterStats[character]) {
                            characterStats[character] = {
                                conversations: 0,
                                messages: 0,
                                totalTime: 0,
                                lastActivity: null
                            };
                        }
                        characterStats[character].conversations++;
                        characterStats[character].totalTime += durationMinutes;

                        const activityDate = new Date(conv.start_time);
                        if (!characterStats[character].lastActivity || activityDate > characterStats[character].lastActivity) {
                            characterStats[character].lastActivity = activityDate;
                        }
                    } catch (convError) {
                        console.warn(`‚ö†Ô∏è Erreur conversation ${conv.id}:`, convError);
                    }
                }

                // Calculer les tendances (cette semaine vs semaine derni√®re)
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                
                const thisWeekConvs = conversations.filter(c => new Date(c.start_time) >= oneWeekAgo);
                const lastWeekConvs = conversations.filter(c => {
                    const date = new Date(c.start_time);
                    return date >= twoWeeksAgo && date < oneWeekAgo;
                });

                // Calculer le niveau et progression
                const { level, progressPercentage } = calculateUserLevel(characterStats, progressData);

                // Afficher les statistiques
                displayGlobalStats({
                    totalConversations,
                    totalMessages,
                    totalTimeMinutes,
                    thisWeekConvs: thisWeekConvs.length,
                    lastWeekConvs: lastWeekConvs.length,
                    level,
                    progressPercentage,
                    characterStats
                });

                // Cr√©er les graphiques
                await createCharts(conversations);

            } catch (err) {
                console.error('‚ùå Erreur calcul stats:', err);
                displayStatsError(err.message);
            }
        }

        function displayGlobalStats(stats) {
            // Masquer le loading
            document.getElementById('globalStatsLoading').classList.add('hidden');
            document.getElementById('globalStats').classList.remove('hidden');

            // Remplir les stats principales
            document.getElementById('totalConversations').textContent = stats.totalConversations;
            document.getElementById('totalMessages').textContent = stats.totalMessages;

            // Formatage du temps
            const hours = Math.floor(stats.totalTimeMinutes / 60);
            const minutes = stats.totalTimeMinutes % 60;
            const timeText = hours > 0 ? `${hours}h${minutes > 0 ? ` ${minutes}m` : ''}` : `${minutes}m`;
            document.getElementById('totalTime').textContent = timeText;
            document.getElementById('currentLevel').textContent = stats.level;

            // Tendances
            const convTrend = stats.thisWeekConvs - stats.lastWeekConvs;
            const convTrendText = convTrend > 0 ? `+${convTrend} cette semaine` :
                                 convTrend < 0 ? `${convTrend} cette semaine` : 'Stable cette semaine';
            document.getElementById('conversationsThisWeek').textContent = convTrendText;

            const avgSessionTime = stats.totalConversations > 0 ?
                Math.round(stats.totalTimeMinutes / stats.totalConversations) : 0;
            document.getElementById('avgSessionTime').textContent = `${avgSessionTime} min/session en moyenne`;
            document.getElementById('progressPercentage').textContent = `${stats.progressPercentage}% compl√©t√©`;

            // Afficher la progression par personnage
            displayCharactersProgress(stats.characterStats);
        }

        function displayCharactersProgress(characterStats) {
            const container = document.getElementById('charactersProgress');
            container.innerHTML = '';

            const characters = ['emma', 'tom', 'lucy', 'ben', 'alice', 'mike', 'sarah'];

            characters.forEach(charKey => {
                const charInfo = getCharacterInfo(charKey);
                const stats = characterStats[charKey] || { conversations: 0, messages: 0, totalTime: 0 };
                const progressPercentage = Math.min(100, (stats.conversations / 3) * 100); // 3 conversations = 100%

                const charCard = document.createElement('div');
                charCard.className = 'bg-white rounded-xl p-4 border border-gray-200 hover:shadow-md transition-all cursor-pointer';
                charCard.onclick = () => filterByCharacter(charKey);

                charCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="character-avatar ${charInfo.class}">
                            ${charInfo.emoji}
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900">${charInfo.name}</div>
                            <div class="text-xs text-gray-500">${stats.conversations} conversation${stats.conversations !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Progression</span>
                            <span class="text-gray-900 font-medium">${Math.round(progressPercentage)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-primary-500 to-secondary-500 h-2 rounded-full transition-all duration-500"
                                 style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>${stats.totalTime}min</span>
                        <span>${stats.conversations > 0 ? 'Actif' : 'Non essay√©'}</span>
                    </div>
                `;

                container.appendChild(charCard);
            });
        }

        async function createCharts(conversations) {
            try {
                // Graphique d'activit√© (7 derniers jours)
                createActivityChart(conversations);
                
                // Graphique d'analyse des erreurs
                await createErrorsChart(conversations);
            } catch (err) {
                console.error('‚ùå Erreur cr√©ation graphiques:', err);
            }
        }

        function createActivityChart(conversations) {
            const ctx = document.getElementById('activityChart').getContext('2d');

            // Pr√©parer les donn√©es des 7 derniers jours
            const labels = [];
            const data = [];
            const now = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const dayLabel = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
                labels.push(dayLabel);

                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

                const dayConversations = conversations.filter(c => {
                    const convDate = new Date(c.start_time);
                    return convDate >= dayStart && convDate < dayEnd;
                });

                data.push(dayConversations.length);
            }

            if (activityChart) {
                activityChart.destroy();
            }

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversations',
                        data: data,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        async function createErrorsChart(conversations) {
            const ctx = document.getElementById('errorsChart').getContext('2d');

            let totalTranslations = 0;
            let totalFrenchResponses = 0;
            let totalUnclearResponses = 0;
            let totalCorrectPhrases = 0;

            // Analyser les erreurs dans toutes les conversations
            for (const conv of conversations) {
                try {
                    const analysisResponse = await authenticatedFetch(`/analyze_session/${conv.id}`);
                    if (analysisResponse && analysisResponse.ok) {
                        const analysis = await analysisResponse.json();
                        totalTranslations += analysis.translations_count || 0;
                        totalFrenchResponses += analysis.french_responses_count || 0;
                        totalUnclearResponses += analysis.unclear_responses_count || 0;
                        totalCorrectPhrases += analysis.correct_phrases_count || 0;
                    }
                } catch (err) {
                    // Ignorer les erreurs pour les conversations individuelles
                }
            }

            const total = totalTranslations + totalFrenchResponses + totalUnclearResponses + totalCorrectPhrases;

            if (total === 0) {
                // Afficher un message si pas de donn√©es
                ctx.canvas.parentNode.innerHTML = `
                    <div class="flex items-center justify-center h-64 text-gray-500">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 012 2v2h2a2 2 0 012 2v6a2 2 0 01-2 2H9z"></path>
                            </svg>
                            <p>Pas encore de donn√©es d'analyse</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (errorsChart) {
                errorsChart.destroy();
            }

            errorsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Phrases correctes', 'Demandes de traduction', 'R√©ponses en fran√ßais', 'R√©ponses floues'],
                    datasets: [{
                        data: [totalCorrectPhrases, totalTranslations, totalFrenchResponses, totalUnclearResponses],
                        backgroundColor: [
                            '#10B981', // Vert pour correct
                            '#F59E0B', // Orange pour traductions
                            '#EF4444', // Rouge pour fran√ßais
                            '#6B7280'  // Gris pour flou
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // ===== FONCTIONS UTILITAIRES =====
        function getCharacterFromCategory(category) {
            const mapping = {
                "conv_greetings_common_conversations": "alice",
                "conv_taxi_booking": "mike",
                "conv_airport_ticket": "sarah",
                "conv_beginner_teacher": "emma",
                "conv_simple_restaurant": "tom",
                "conv_simple_shopping": "lucy",
                "conv_simple_directions": "ben"
            };
            return mapping[category] || 'unknown';
        }

        function getCharacterInfo(charKey) {
            const mapping = {
                "emma": { name: "Emma", emoji: "üë©‚Äçüè´", class: "character-emma" },
                "tom": { name: "Tom", emoji: "üçï", class: "character-tom" },
                "lucy": { name: "Lucy", emoji: "üõçÔ∏è", class: "character-lucy" },
                "ben": { name: "Ben", emoji: "üó∫Ô∏è", class: "character-ben" },
                "alice": { name: "Alice", emoji: "üåü", class: "character-alice" },
                "mike": { name: "Mike", emoji: "üöï", class: "character-mike" },
                "sarah": { name: "Sarah", emoji: "‚úàÔ∏è", class: "character-sarah" }
            };
            return mapping[charKey] || { name: "Inconnu", emoji: "‚ùì", class: "character-unknown" };
        }

        function calculateUserLevel(characterStats, progressData) {
            const beginnerChars = ['emma', 'tom', 'lucy', 'ben'];
            const intermediateChars = ['alice'];
            const advancedChars = ['mike', 'sarah'];

            const beginnerProgress = beginnerChars.filter(char =>
                characterStats[char] && characterStats[char].conversations > 0
            ).length;

            const intermediateProgress = intermediateChars.filter(char =>
                characterStats[char] && characterStats[char].conversations > 0
            ).length;

            const advancedProgress = advancedChars.filter(char =>
                characterStats[char] && characterStats[char].conversations > 0
            ).length;

            let level = "D√©butant";
            let progressPercentage = 0;

            if (beginnerProgress === 0) {
                level = "Nouveau";
                progressPercentage = 0;
            } else if (beginnerProgress < 4) {
                level = "D√©butant";
                progressPercentage = (beginnerProgress / 4) * 40;
            } else if (intermediateProgress === 0) {
                level = "D√©butant Avanc√©";
                progressPercentage = 40;
            } else if (advancedProgress === 0) {
                level = "Interm√©diaire";
                progressPercentage = 40 + (intermediateProgress / 1) * 30;
            } else {
                level = "Avanc√©";
                progressPercentage = 70 + (advancedProgress / 2) * 30;
            }

            return { level, progressPercentage: Math.round(progressPercentage) };
        }

        function filterByCharacter(character) {
            const filter = document.getElementById('characterFilter');
            filter.value = character;
            loadSessionReports();
        }

        function displayStatsError(message) {
            document.getElementById('globalStatsLoading').classList.add('hidden');
            document.getElementById('globalStats').innerHTML = `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Erreur de chargement</h3>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
            document.getElementById('globalStats').classList.remove('hidden');
        }

        // ===== CHARGEMENT DES SESSIONS =====
        async function loadSessionReports() {
            try {
                const response = await authenticatedFetch('/user/conversations');
                
                if (!response || !response.ok) {
                    throw new Error(`Erreur HTTP ${response?.status || 'inconnue'}`);
                }

                let conversations = await response.json();
                console.log('üìã Sessions charg√©es:', conversations);

                // Filtrer par personnage si s√©lectionn√©
                const characterFilter = document.getElementById('characterFilter').value;
                if (characterFilter) {
                    const categoryFilter = getCategoryFromCharacter(characterFilter);
                    conversations = conversations.filter(conv => conv.category === categoryFilter);
                }

                // Masquer le loading
                document.getElementById('sessionsLoading').classList.add('hidden');

                const sortOrder = document.getElementById('sortOrder').value;
                if (sortOrder === 'desc') {
                    conversations.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
                } else {
                    conversations.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
                }

                const sessionReportsContainer = document.getElementById('sessionReports');
                const noSessionsContainer = document.getElementById('noSessions');

                if (conversations.length === 0) {
                    sessionReportsContainer.classList.add('hidden');
                    noSessionsContainer.classList.remove('hidden');
                    return;
                }

                sessionReportsContainer.classList.remove('hidden');
                noSessionsContainer.classList.add('hidden');
                sessionReportsContainer.innerHTML = '';

                // Grouper par date pour une meilleure organisation
                const groupedConversations = groupConversationsByDate(conversations);

                Object.keys(groupedConversations).forEach(dateKey => {
                    // Ajouter un en-t√™te de date
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'flex items-center space-x-3 mb-4 mt-6 first:mt-0';
                    dateHeader.innerHTML = `
                        <div class="h-px bg-gray-300 flex-1"></div>
                        <span class="text-sm font-medium text-gray-500 bg-gray-50 px-3 py-1 rounded-full">
                            ${formatDateHeader(dateKey)}
                        </span>
                        <div class="h-px bg-gray-300 flex-1"></div>
                    `;
                    sessionReportsContainer.appendChild(dateHeader);

                    // Ajouter les conversations de cette date
                    groupedConversations[dateKey].forEach((conversation, index) => {
                        const sessionDiv = createSessionCard(conversation, index);
                        sessionReportsContainer.appendChild(sessionDiv);
                    });
                });

            } catch (err) {
                console.error('‚ùå Erreur lors du chargement des sessions:', err);
                document.getElementById('sessionsLoading').classList.add('hidden');
                document.getElementById('sessionReports').innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Erreur de chargement</h3>
                        <p class="text-gray-600">${err.message}</p>
                    </div>
                                    `;
                document.getElementById('sessionReports').classList.remove('hidden');
            }
        }

        function groupConversationsByDate(conversations) {
            const grouped = {};
            conversations.forEach(conv => {
                const date = new Date(conv.start_time);
                const dateKey = date.toDateString();
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(conv);
            });
            return grouped;
        }

        function formatDateHeader(dateKey) {
            const date = new Date(dateKey);
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);

            if (date.toDateString() === today.toDateString()) {
                return "Aujourd'hui";
            } else if (date.toDateString() === yesterday.toDateString()) {
                return "Hier";
            } else {
                return date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function createSessionCard(conversation, index) {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'session-item p-6 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300 bg-white';
            sessionDiv.setAttribute('data-conversation-id', conversation.id);

            const date = new Date(conversation.start_time);
            const timeOnly = date.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Obtenir les infos du personnage
            const characterInfo = characterMapping[conversation.category] || { name: "Inconnu", emoji: "‚ùì", class: "bg-gray-500" };

            // Calculer la dur√©e approximative
            const endTime = conversation.end_time ? new Date(conversation.end_time) : new Date();
            const durationMs = endTime - date;
            const durationMinutes = Math.max(1, Math.floor(durationMs / 60000));

            sessionDiv.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="character-avatar ${characterInfo.class}">
                            ${characterInfo.emoji}
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 flex items-center space-x-2">
                                <span>Session avec ${characterInfo.name}</span>
                                <span class="text-sm bg-gray-100 text-gray-600 px-2 py-1 rounded-full">${timeOnly}</span>
                            </h3>
                            <p class="text-sm text-gray-600">${categoryMapping[conversation.category] || conversation.category}</p>
                            <p class="text-xs text-gray-500 mt-1">Dur√©e: ~${durationMinutes} minute${durationMinutes !== 1 ? 's' : ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="pulse-dot w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-500">Termin√©e</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Aper√ßu rapide des performances -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4" id="quickStats_${conversation.id}">
                    <div class="text-xs text-gray-500 mb-2">Aper√ßu rapide :</div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-gray-600">Chargement...</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button onclick="viewSessionAnalysis('${conversation.id}')"
                            class="inline-flex items-center px-4 py-2 bg-primary-100 text-primary-700 rounded-lg hover:bg-primary-200 transition-colors text-sm font-medium">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Voir l'analyse
                    </button>
                    <button onclick="continueWithCharacter('${getCharacterFromCategory(conversation.category)}')"
                            class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm font-medium">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Continuer
                    </button>
                </div>
            `;

            // Event listener pour le clic sur la session (non sur les boutons)
            sessionDiv.addEventListener('click', async (e) => {
                if (!e.target.closest('button')) {
                    await viewSessionAnalysis(conversation.id);
                }
            });

            // Charger l'aper√ßu rapide
            loadQuickStats(conversation.id);

            return sessionDiv;
        }

        async function loadQuickStats(conversationId) {
            try {
                const response = await authenticatedFetch(`/analyze_session/${conversationId}`);
                if (response && response.ok) {
                    const data = await response.json();
                    const container = document.getElementById(`quickStats_${conversationId}`);
                    if (container) {
                        const successRate = data.total_messages > 0 ?
                            Math.round(((data.total_messages - data.french_responses_count - data.unclear_responses_count) / data.total_messages) * 100) : 0;

                        container.innerHTML = `
                            <div class="text-xs text-gray-500 mb-2">Aper√ßu rapide :</div>
                            <div class="flex items-center space-x-4 text-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span class="text-gray-600">${successRate}% r√©ussite</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    <span class="text-gray-600">${data.total_messages} messages</span>
                                </div>
                                ${data.translations_count > 0 ? `
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                        <span class="text-gray-600">${data.translations_count} traductions</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }
            } catch (err) {
                // Ignorer les erreurs pour l'aper√ßu rapide
                console.warn('‚ö†Ô∏è Erreur aper√ßu rapide:', err);
            }
        }

        function getCategoryFromCharacter(character) {
            const mapping = {
                'emma': 'conv_beginner_teacher',
                'tom': 'conv_simple_restaurant',
                'lucy': 'conv_simple_shopping',
                'ben': 'conv_simple_directions',
                'alice': 'conv_greetings_common_conversations',
                'mike': 'conv_taxi_booking',
                'sarah': 'conv_airport_ticket'
            };
            return mapping[character] || '';
        }

        function continueWithCharacter(character) {
            const characterEndpoints = {
                'emma': 'conv_beginner_teacher',
                'tom': 'conv_simple_restaurant',
                'lucy': 'conv_simple_shopping',
                'ben': 'conv_simple_directions',
                'alice': 'conv_greetings_common_conversations',
                'mike': 'conv_taxi_booking',
                'sarah': 'conv_airport_ticket'
            };

            const choice = characterEndpoints[character];
            if (choice) {
                window.location.href = `course.html?choice=${choice}`;
            }
        }

        // ===== ANALYSE DE SESSION =====
        async function viewSessionAnalysis(conversationId) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('analysisContainer').classList.remove('hidden');
            await displaySessionAnalysis(conversationId);

            // Mettre en surbrillance la session s√©lectionn√©e
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('bg-primary-50', 'border-primary-300');
            });

            const sessionItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (sessionItem) {
                sessionItem.classList.add('bg-primary-50', 'border-primary-300');
            }
        }

        async function displaySessionAnalysis(conversationId) {
            try {
                const response = await authenticatedFetch(`/analyze_session/${conversationId}`);
                
                if (!response || !response.ok) {
                    throw new Error(`Erreur HTTP ${response?.status || 'inconnue'}`);
                }

                const data = await response.json();
                console.log('üìä Donn√©es d\'analyse re√ßues:', data);

                const analysisContainer = document.getElementById('analysisContainer');
                analysisContainer.innerHTML = '';

                // Obtenir les infos du personnage
                const characterInfo = characterMapping[data.category] || { name: "Inconnu", emoji: "‚ùì" };

                // En-t√™te de l'analyse
                const headerDiv = document.createElement('div');
                headerDiv.className = 'bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-t-2xl p-6';
                headerDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="character-avatar ${characterInfo.class || 'bg-gray-500'}">
                                ${characterInfo.emoji}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold mb-2">üìã Rapport de Session avec ${characterInfo.name}</h2>
                                <p class="text-primary-100">${categoryMapping[data.category] || data.category}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">${data.duration}</div>
                            <div class="text-primary-200 text-sm">Dur√©e totale</div>
                        </div>
                    </div>
                `;
                analysisContainer.appendChild(headerDiv);

                // Container principal
                const mainContainer = document.createElement('div');
                mainContainer.className = 'bg-white rounded-b-2xl shadow-lg border border-gray-100';

                // Statistiques principales
                const statsGrid = document.createElement('div');
                statsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6';

                // Calculer le taux de r√©ussite
                const totalInteractions = data.total_messages;
                const errorsCount = data.french_responses_count + data.unclear_responses_count;
                const successRate = totalInteractions > 0 ? Math.round(((totalInteractions - errorsCount) / totalInteractions) * 100) : 0;

                statsGrid.innerHTML = `
                    <div class="stat-card border-blue-500 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold text-gray-900">${data.total_messages}</div>
                                <div class="text-sm text-gray-600">Messages totaux</div>
                                <div class="text-xs text-blue-600 mt-1">√âchanges durant la session</div>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card border-green-500 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold text-gray-900">${successRate}%</div>
                                <div class="text-sm text-gray-600">Taux de r√©ussite</div>
                                <div class="text-xs text-green-600 mt-1">${data.correct_phrases_count} phrases correctes</div>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card border-orange-500 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold text-gray-900">${data.translations_count}</div>
                                <div class="text-sm text-gray-600">Demandes de traduction</div>
                                <div class="text-xs text-orange-600 mt-1">Aide linguistique demand√©e</div>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card border-purple-500 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold text-gray-900">${data.avg_user_response_time}</div>
                                <div class="text-sm text-gray-600">Temps de r√©ponse</div>
                                <div class="text-xs text-purple-600 mt-1">Temps moyen de r√©flexion</div>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                `;
                mainContainer.appendChild(statsGrid);

                // Graphique circulaire pour cette session
                if (data.total_messages > 0) {
                    const chartSection = document.createElement('div');
                    chartSection.className = 'px-6 pb-6';
                    chartSection.innerHTML = `
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">üìä R√©partition des r√©ponses</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="relative h-64">
                                    <canvas id="sessionChart_${conversationId}"></canvas>
                                </div>
                                <div class="flex flex-col justify-center space-y-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                                        <span class="text-sm text-gray-700">Phrases correctes: ${data.correct_phrases_count}</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-orange-500 rounded"></div>
                                        <span class="text-sm text-gray-700">Traductions: ${data.translations_count}</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-red-500 rounded"></div>
                                        <span class="text-sm text-gray-700">Fran√ßais: ${data.french_responses_count}</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-4 h-4 bg-gray-500 rounded"></div>
                                        <span class="text-sm text-gray-700">R√©ponses floues: ${data.unclear_responses_count}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    mainContainer.appendChild(chartSection);
                }

                // Analyse de performance
                const performanceSection = document.createElement('div');
                performanceSection.className = 'px-6 pb-6';

                // G√©n√©rer des recommandations bas√©es sur les performances
                const recommendations = generateRecommendations(data, characterInfo);

                performanceSection.innerHTML = `
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Analyse de Performance D√©taill√©e
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700">Taux de r√©ussite :</span>
                                    <span class="font-semibold text-gray-900 flex items-center">
                                        ${successRate}%
                                        ${successRate >= 80 ? 'üéâ' : successRate >= 60 ? 'üëç' : 'üí™'}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700">R√©ponses en fran√ßais :</span>
                                    <span class="font-semibold text-gray-900">${data.french_responses_count}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700">Incompr√©hensions :</span>
                                    <span class="font-semibold text-gray-900">${data.unclear_responses_count}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700">Sentiment g√©n√©ral :</span>
                                    <span class="font-semibold text-gray-900">Positif</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <h4 class="font-semibold text-gray-900">üéØ Recommandations</h4>
                                ${recommendations.map(rec => `
                                    <div class="flex items-start space-x-2">
                                        <span class="text-lg">${rec.icon}</span>
                                        <span class="text-sm text-gray-700">${rec.text}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ${data.translations && data.translations.length > 0 ? `
                            <div class="border-t border-gray-200 pt-4">
                                <h4 class="font-semibold text-gray-900 mb-3">üî§ Derni√®res traductions demand√©es</h4>
                                <div class="space-y-3">
                                    ${data.translations.slice(0, 3).map(([user_input, response]) => `
                                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                                            <div class="text-sm text-gray-600 mb-1">Vous avez dit :</div>
                                            <div class="font-medium text-gray-900 mb-2">"${user_input}"</div>
                                            <div class="text-sm text-gray-600 mb-1">Traduction :</div>
                                            <div class="text-sm text-blue-700 bg-blue-50 px-3 py-1 rounded">"${response}"</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                mainContainer.appendChild(performanceSection);
                analysisContainer.appendChild(mainContainer);

                // Cr√©er le graphique pour cette session
                setTimeout(() => {
                    createSessionChart(conversationId, data);
                }, 100);

            } catch (err) {
                console.error('‚ùå Erreur lors du chargement de l\'analyse:', err);
                const analysisContainer = document.getElementById('analysisContainer');
                analysisContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                        <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-900 mb-2">Erreur de chargement</h3>
                        <p class="text-red-700">${err.message}</p>
                    </div>
                `;
            }
        }

        function generateRecommendations(data, characterInfo) {
            const recommendations = [];
            const successRate = data.total_messages > 0 ?
                Math.round(((data.total_messages - data.french_responses_count - data.unclear_responses_count) / data.total_messages) * 100) : 0;

            if (successRate >= 90) {
                recommendations.push({
                    icon: 'üéâ',
                    text: 'Excellent travail ! Vous ma√Ætrisez tr√®s bien la conversation avec ' + characterInfo.name
                });
                
                const nextCharacter = getNextRecommendedCharacter(data.category);
                if (nextCharacter) {
                    recommendations.push({
                        icon: 'üöÄ',
                        text: `Pr√™t pour le d√©fi suivant ? Essayez ${nextCharacter}`
                    });
                }
            } else if (successRate >= 70) {
                recommendations.push({
                    icon: 'üëç',
                    text: 'Bon travail ! Continuez √† pratiquer avec ' + characterInfo.name + ' pour vous am√©liorer'
                });
            } else if (successRate >= 50) {
                recommendations.push({
                    icon: 'üí™',
                    text: 'Vous progressez ! Concentrez-vous sur l\'√©coute et la r√©p√©tition'
                });
            } else {
                recommendations.push({
                    icon: 'üå±',
                    text: 'Ne vous d√©couragez pas ! Chaque conversation vous aide √† progresser'
                });
            }

            if (data.french_responses_count > 2) {
                recommendations.push({
                    icon: 'üá¨üáß',
                    text: 'Essayez de r√©pondre en anglais m√™me si c\'est simple (Yes, No, I don\'t know)'
                });
            }

            if (data.translations_count > 3) {
                recommendations.push({
                    icon: 'üìö',
                    text: 'R√©visez le vocabulaire de base avant votre prochaine session'
                });
            }

            if (data.unclear_responses_count > 2) {
                recommendations.push({
                    icon: 'üó£Ô∏è',
                    text: 'Parlez lentement et clairement, utilisez des phrases courtes'
                });
            }

            return recommendations;
        }

        function getNextRecommendedCharacter(currentCategory) {
            const progression = {
                'conv_beginner_teacher': 'üçï Tom (Restaurant)',
                'conv_simple_restaurant': 'üõçÔ∏è Lucy (Shopping)',
                'conv_simple_shopping': 'üó∫Ô∏è Ben (Directions)',
                'conv_simple_directions': 'üåü Alice (Conversation g√©n√©rale)',
                'conv_greetings_common_conversations': 'üöï Mike (Taxi)',
                'conv_taxi_booking': '‚úàÔ∏è Sarah (A√©roport)'
            };
            return progression[currentCategory] || null;
        }

        function createSessionChart(conversationId, data) {
            const canvasId = `sessionChart_${conversationId}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Phrases correctes', 'Traductions', 'Fran√ßais', 'R√©ponses floues'],
                    datasets: [{
                        data: [
                            data.correct_phrases_count || 0,
                            data.translations_count || 0,
                            data.french_responses_count || 0,
                            data.unclear_responses_count || 0
                        ],
                        backgroundColor: [
                            '#10B981', // Vert
                            '#F59E0B', // Orange
                            '#EF4444', // Rouge
                            '#6B7280'  // Gris
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ===== CHARGEMENT DU PROFIL UTILISATEUR =====
        async function loadUserProfile() {
            try {
                const response = await authenticatedFetch('/users/me');
                
                if (response && response.ok) {
                    const user = await response.json();
                    console.log('üë§ Utilisateur charg√©:', user);

                    // Mettre √† jour les √©l√©ments du profil
                    const profileName = document.getElementById('profile-name');
                    const profileEmail = document.getElementById('profile-email');
                    const profileNameMenu = document.getElementById('profile-name-menu');
                    const profileEmailMenu = document.getElementById('profile-email-menu');
                    const profileAvatar = document.getElementById('profile-avatar');
                    const profileAvatarMenu = document.getElementById('profile-avatar-menu');

                    if (profileName) profileName.textContent = user.nom || 'Utilisateur';
                    if (profileEmail) profileEmail.textContent = user.email || '';
                    if (profileNameMenu) profileNameMenu.textContent = user.nom || 'Utilisateur';
                    if (profileEmailMenu) profileEmailMenu.textContent = user.email || '';
                    
                    // Mettre √† jour l'avatar si disponible
                    if (user.avatar_url) {
                        if (profileAvatar) profileAvatar.src = user.avatar_url;
                        if (profileAvatarMenu) profileAvatarMenu.src = user.avatar_url;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur profil:', error);
            }
        }

        // ===== FONCTION LOGOUT =====
        function logout() {
            localStorage.clear();
            window.location.href = "/form-login.html";
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initialisation de la page d\'analyse...');
            
            // V√©rifier l'authentification
            const token = getAuthToken();
            if (!token) {
                console.error('‚ùå Non authentifi√©, redirection...');
                window.location.href = '/form-login.html';
                return;
            }

            // Initialiser l'interface
            initializeUI();

            // G√©rer l'analyse sp√©cifique si ID de conversation dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation_id');
            if (conversationId) {
                document.getElementById('analysisContainer').classList.remove('hidden');
                await displaySessionAnalysis(conversationId);
            }

            // Charger les donn√©es principales
            await loadGlobalStats();
            await loadSessionReports();
            await loadUserProfile();

            console.log('‚úÖ Page d\'analyse initialis√©e avec succ√®s !');
        });
    </script>
</body>
</html>